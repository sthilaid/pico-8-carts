pico-8 cartridge // http://www.pico-8.com
version 30
__lua__
--skate by sthilaid

-- globals
g_lastFrameTime=0
g_skate={}
g_jmpImpulse = 3
g_inairAnimUp={0,4,8,12,8,4,0}

-->8
-- updates
function _init()
   g_skate = {x=64,y=64,z=0,v=0,vz=0,dir=0,state=0,
              spriteSize=4}
end

function _update()
   local t = time()
   local dt = t - g_lastFrameTime
   g_lastFrameTime = t

   -- state 0: ground
   if g_skate.state == 0 then
      local dx,dy,dr = 0,0,0
      if (btn(0)) dr = 1
      if (btn(1)) dr = -1
      if dr != 0 then
         g_skate.dir += dr * 0.01
      end
      if btnp(5) then
         if btn(0) or btn(1) then
            g_skate.state = 2 -- x+side -> flip trick
         else
            g_skate.state = 1 -- x+side -> ollie
         end
         g_skate.vz = g_jmpImpulse -- m/s
      end
   end
   -- in air
   if g_skate.state == 1 or g_skate.state == 2 then
      g_skate.z += g_skate.vz*dt
      g_skate.vz -= 9.8*dt

      if g_skate.z < 0 then
         g_skate.z, g_skate.vz = 0, 0
         g_skate.state = 0 -- ground
      end
   end
end

function round(x) return flr(x+0.5) end
function clamp(minv,maxv,v) return min(maxv, max(minv, v)) end
-- rotate x,y of angle around origin
function rot(x,y,ang)
   local theta = atan2(x,y)
   local l = sqrt(x*x+y*y)
   return cos(theta+ang)*l, sin(theta+ang)*l
end

-- rotate sprite s into sprite ds
--   s:         sprite index
--   spr_size:  size of sprite (as used in spr calls)
--   angle:     rotation angle (in pico angles [0,1] not radians or degrees)
--   ds:        destination sprite index
function rotateSprite(s,spr_size,angle,ds)
   local size = spr_size * 8
   local halfsize = size*0.5
   local sx,sy = (s % 16) * 8, (s \ 16) * 8
   local dsx,dsy = (ds % 16) * 8, (ds \ 16) * 8
   for i=0,size-1 do
      for j=0,size-1 do
         local u,v = rot(i-halfsize,j-halfsize,-angle)
         local c = 0
         if (u > -halfsize and u < halfsize and v > -halfsize and v < halfsize) then
            local cx = clamp(sx,sx+size-1,sx+halfsize+round(u))
            local cy = clamp(sy,sy+size-1,sy+halfsize+round(v))
            c = sget(cx,cy)
         end
         sset(dsx+i, dsy+j, c)
         end
   end
end

function _draw()
   cls()
   print("s:"..g_skate.state.." z:"..g_skate.z.." vz:"..g_skate.vz.." d:"..g_skate.dir)
   
   local centerDelta = -g_skate.spriteSize*4 -- /2 * 8
   if g_skate.state == 0 then
      rotateSprite(0,g_skate.spriteSize, g_skate.dir, 64)
      spr(64, g_skate.x+centerDelta, g_skate.y+centerDelta, g_skate.spriteSize, g_skate.spriteSize)
   elseif g_skate.state == 1 then
      if g_skate.vz > 0 then
         local sprIndex = flr((1.0 - g_skate.vz / g_jmpImpulse) * #g_inairAnimUp + 1)
         local inairSprite = g_inairAnimUp[sprIndex]
         rotateSprite(inairSprite,g_skate.spriteSize, g_skate.dir, 64)
         spr(64, g_skate.x+centerDelta, g_skate.y+centerDelta, g_skate.spriteSize, g_skate.spriteSize)
      else
         rotateSprite(0,g_skate.spriteSize, g_skate.dir, 64)
         spr(64, g_skate.x+centerDelta, g_skate.y+centerDelta, g_skate.spriteSize, g_skate.spriteSize)
      end
   end
end

__gfx__
00000000000000555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000555555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005555555555500000000000000000000000004444000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005555555555500000000000000000000000444444440000000000000000000000000000000000000000000000000000000000000000000000000000
00000000055555555555550000000000000000000004555555554000000000000000000000000000000000000000000000000000000000000000000000000000
00000000055555555555550000000000000000000045555555555400000000000000000000844444444480000000000000000000000000000000000000000000
00000000055555555555550000000000000000000555555555555500000000000000000008444444444448000000000000000000000000000000000000000000
00000000055555555555550000000000000000000555555555555500000000000000000004444444444444000000000000000000088000000000880000000000
00000000055555555555550000000000000000000555555555555500000000000000000004445555555544000000000000000000088666666666880000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000088444444444880000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000084444444444480000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000044444444444440000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000044455555555440000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555550000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000055555555555500000000000000000000555555555555500000000000000000005555555555555000000000000000000055555555555550000000000
00000000005555555555500000000000000000000555555555555000000000000000000005555555555550000000000000000000055555555555500000000000
00000000005555555555500000000000000000000055555555555000000000000000000000555555555550000000000000000000005555555555500000000000
00000000005555555555500000000000000000000055555555555000000000000000000000555555555550000000000000000000005555555555500000000000
00000000005555555555000000000000000000000005555555550000000000000000000000055555555500000000000000000000000555555555000000000000
00000000000555555550000000000000000000000005555555500000000000000000000000055555555000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000005555555555555555555550000000000004555555555555555555550000000000008445555555555555555500000000000008888445555555555
00000000005555555555555555555555555555000000045555555555555555555555550000000084445555555555555555555500000000008884445555555555
00000000055555555555555555555555555555500000455555555555555555555555555000000044455555555555555555555550000000000644455555555555
00000000055555555555555555555555555555550000455555555555555555555555555500000044455555555555555555555555000000000644455555555555
00000000555555555555555555555555555555550004455555555555555555555555555500000044455555555555555555555555000000000644455555555555
00000000555555555555555555555555555555550004455555555555555555555555555500000044455555555555555555555555000000000644455555555555
00000000555555555555555555555555555555550004455555555555555555555555555500000044455555555555555555555555000000000644455555555555
00000000555555555555555555555555555555550004455555555555555555555555555500000044455555555555555555555555000000000644455555555555
00000000055555555555555555555555555555550000455555555555555555555555555500000044455555555555555555555555000000000644455555555555
00000000055555555555555555555555555555550000455555555555555555555555555500000044455555555555555555555555000000000644455555555555
00000000055555555555555555555555555555550000045555555555555555555555555500000044445555555555555555555555000000000644445555555555
00000000005555555555555555555555555555500000004555555555555555555555550000000084445555555555555555555500000000008884445555555555
00000000000005555555555555555555555000000000000555555555555555555555000000000008445555555555555555550000000000008888445555555555
