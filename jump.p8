pico-8 cartridge // http://www.pico-8.com
version 38
__lua__

p={}
ground=119
debug={}

function _init()
   setPosition(10, 10)
   p.vx = 0
   p.vy = 0
   p.w = 3
   p.h = 7
   p.leftoverDX = 0
   p.leftoverDY = 0
   p.momentum = 0
   setState(0) -- 0: ground, 1: inair

   poke(0X5F5C, 255) -- never repeat inputs
end

function _update()
   updatePlayerInputs()
   movePlayer()
   if p.momentum > 0 and getTimeSinceMove() > 1.0 then
      p.momentum = 0
   end
end

function getSpeed()
   if (p.momentum == 1) return 1.3
   if (p.momentum == 2) return 1.5
   if (p.momentum == 3) return 1.7
   if (p.momentum == 4) return 2.1
   return 1
end

function incMomentum()
   p.momentum = min(p.momentum+1, 4)
end

function updatePlayerInputs()
   local dv = getSpeed()
   if (btn(0)) p.vx -= dv
   if (btn(1)) p.vx += dv
   if (btn(4)) updateJumpInput()
end

function setPosition(x, y)
   if x ~= p.x or y ~= p.y then
      p.x = x
      p.y = y
      p.lastMoveTime = time()
   end
end

function getTimeSinceMove()
   return time() - p.lastMoveTime
end

function setState(newState)
   if newState ~= p.state then
      p.state = newState
      p.stateStartTime = time()
   end
end

function getStateDuration()
   return time() - p.stateStartTime
end

function canJump()
   return p.state == 0 or (p.state == 1 and getStateDuration() < 0.1)
end

function updateJumpInput()
   if canJump() and btnp(4) then
      p.vy -= 5
      setState(1)
      incMomentum()
   else
      if p.state == 1 and btn(4) and getStateDuration() < 0.3 then
         p.vy -= 0.6
      end
   end
end

function intersect(x,y,w,h,flag)
   for i=x,x+w do
      local cx = i \ 8
      for j=y,y+h do
         local cy = j \ 8
         local tile = mget(cx, cy)
         if fget(tile, flag) then
            return true
         end
      end
   end
   return false
end

function largerWithDir(a, b, dir)
   if dir < 0 then
      if (a < b) return a else return b
    else
       if (a > b) return a else return b
    end
end

function move(requestedDX, requestedDY)
   local fullDX,fullDY = requestedDX + p.leftoverDX, requestedDY + p.leftoverDY
   local dx, dy = flr(fullDX), flr(fullDY)
   local safeX, safeY = p.x, p.y
   local dirX, dirY = dx / abs(dx), dy / abs(dy)
   local collisionReport = {false, false}
   for deltaX=0,abs(dx) do
      for deltaY=0,abs(dy) do
         if not collisionReport[1] then
            local x, y = largerWithDir(p.x + dirX*deltaX, safeX, dirX), safeY
            local isColliding = intersect(x, y, p.w, p.h, 0)
            if isColliding then
               collisionReport[1] = true
            else
               safeX = x
            end
         end
         if not collisionReport[2] then
            x, y = safeX, largerWithDir(p.y + dirY*deltaY, safeY, dirY)
            isColliding = intersect(x, y, p.w, p.h, 0)
            if isColliding then
               collisionReport[2] = true
            else
               safeY = y
            end
         end
      end
   end
   setPosition(safeX, safeY)
   p.leftoverDX = fullDX - dx
   p.leftoverDY = fullDY - dy
   return collisionReport
end

function detectGround()
   return intersect(p.x, p.y+p.h+1, p.w, 0, 0)
end

function movePlayer()
   local report = move(p.vx, p.vy)
   local horizontalCollision, verticalCollision = report[1], report[2]
   if horizontalCollision then
      p.vx = 0
      p.momentum = 0
   end
   if verticalCollision then
      p.vy = 0
   end
   local onGround = detectGround()
   if onGround then
      if p.vy >= 0 then
         p.vy = 0
         setState(0)
      end
   else
      setState(1)
      p.vy += 1
   end
   p.vx = 0
end

function _draw()
   cls(0)
   camera(p.x-32,0)
   drawWorld()
   drawPlayer()
   camera()
   print("p: {"..p.x..","..p.y.."} v: {"..p.vx..","..p.vy.."} idle: "..getTimeSinceMove())
   print("m: "..p.momentum.." s: "..p.state.." ("..getStateDuration()..")")
end

function drawPlayer()
   local x0 = p.x
   local x1 = x0 + p.w
   local y0 = p.y
   local y1 = y0 + p.h
   local c = 11
   if (p.state == 1) c = 14
   rectfill(x0,y0,x1,y1,c)
end

function drawWorld()
   map(0,0,0,0,128,64)
end

__gfx__
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000010100000000000000000000000000000000000000000000000000000001010000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000001010000000001010000000000000000000001010000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000010100000000000000000001010000000000000000000001010000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000010100000000000000010100000000000000000001010000000000000000000001010000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
